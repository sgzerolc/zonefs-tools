## Test 0310: sequential file 4K synchronous write

+ require_program fio
+ type -p fio
/usr/local/bin/fio
+ echo 'Check sequential file 4K sync write'
Check sequential file 4K sync write
+ zonefs_mkfs /dev/vda
+ IFS=' '
+ read -r -a args
+ mkzonefs -f /dev/vda
/dev/vda: 1572864 512-byte sectors (0 GiB)
  Host-managed device
  12 zones of 131072 512-byte sectors (64 MiB)
  0 conventional zones, 12 sequential zones
  0 read-only zones, 0 offline zones
Format:
  11 usable zones
  Aggregate conventional zones: disabled
  File UID: 0
  File GID: 0
  File access permissions: 640
  FS UUID: c624578c-59f4-45dd-9f72-3fc54a47d20f
Resetting sequential zones
Writing super block
+ zonefs_mount /dev/vda
+ IFS=' '
+ read -r -a args
+ mount -t zonefs /dev/vda /home/sam/zonefs-tools/tests/vda-mnt
++ file_max_size /home/sam/zonefs-tools/tests/vda-mnt/seq/0
+++ stat -c %b /home/sam/zonefs-tools/tests/vda-mnt/seq/0
++ nr_blocks=131072
+++ stat -c %B /home/sam/zonefs-tools/tests/vda-mnt/seq/0
++ block_size=512
++ echo 67108864
+ sz=67108864
+ truncate --no-create --size=0 /home/sam/zonefs-tools/tests/vda-mnt/seq/0
+ fio --name=seqwrite --filename=/home/sam/zonefs-tools/tests/vda-mnt/seq/0 --create_on_open=0 --allow_file_create=0 --file_append=1 --unlink=0 --rw=write --ioengine=psync --max-jobs=8 --bs=4096 --size=67108864 --verify=md5 --do_verify=1 --continue_on_error=none --direct=1
seqwrite: (g=0): rw=write, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=psync, iodepth=1
fio-3.32
Starting 1 process
seqwrite: Laying out IO file (1 file / 64MiB)

seqwrite: (groupid=0, jobs=1): err= 0: pid=5769: Mon Dec 18 02:11:47 2023
  read: IOPS=9092, BW=35.5MiB/s (37.2MB/s)(64.0MiB/1802msec)
    clat (usec): min=64, max=9858, avg=97.87, stdev=118.37
     lat (usec): min=64, max=9859, avg=97.99, stdev=118.38
    clat percentiles (usec):
     |  1.00th=[   73],  5.00th=[   75], 10.00th=[   76], 20.00th=[   77],
     | 30.00th=[   79], 40.00th=[   87], 50.00th=[   93], 60.00th=[   98],
     | 70.00th=[  104], 80.00th=[  113], 90.00th=[  125], 95.00th=[  135],
     | 99.00th=[  157], 99.50th=[  165], 99.90th=[  249], 99.95th=[  529],
     | 99.99th=[ 8291]
  write: IOPS=987, BW=3948KiB/s (4043kB/s)(64.0MiB/16599msec); 0 zone resets
    clat (usec): min=730, max=18059, avg=997.03, stdev=495.42
     lat (usec): min=742, max=18074, avg=1010.78, stdev=495.82
    clat percentiles (usec):
     |  1.00th=[  791],  5.00th=[  824], 10.00th=[  848], 20.00th=[  889],
     | 30.00th=[  914], 40.00th=[  938], 50.00th=[  955], 60.00th=[  979],
     | 70.00th=[  996], 80.00th=[ 1029], 90.00th=[ 1090], 95.00th=[ 1172],
     | 99.00th=[ 1582], 99.50th=[ 2073], 99.90th=[10028], 99.95th=[10552],
     | 99.99th=[15270]
   bw (  KiB/s): min=  664, max= 4152, per=97.61%, avg=3854.79, stdev=589.75, samples=34
   iops        : min=  166, max= 1038, avg=963.68, stdev=147.43, samples=34
  lat (usec)   : 100=31.68%, 250=18.28%, 500=0.02%, 750=0.02%, 1000=35.67%
  lat (msec)   : 2=14.04%, 4=0.16%, 10=0.09%, 20=0.05%
  cpu          : usr=1.33%, sys=1.35%, ctx=47484, majf=0, minf=415
  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     issued rwts: total=16384,16384,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=1

Run status group 0 (all jobs):
   READ: bw=35.5MiB/s (37.2MB/s), 35.5MiB/s-35.5MiB/s (37.2MB/s-37.2MB/s), io=64.0MiB (67.1MB), run=1802-1802msec
  WRITE: bw=3948KiB/s (4043kB/s), 3948KiB/s-3948KiB/s (4043kB/s-4043kB/s), io=64.0MiB (67.1MB), run=16599-16599msec

Disk stats (read/write):
  vda: ios=16340/16384, merge=0/0, ticks=1351/15713, in_queue=17064, util=99.40%
+ zonefs_umount
+ udevadm settle
+ umount /home/sam/zonefs-tools/tests/vda-mnt
+ set +x
PASS

